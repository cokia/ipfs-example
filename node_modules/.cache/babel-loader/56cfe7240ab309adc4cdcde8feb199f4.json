{"ast":null,"code":"'use strict';\n\nconst promisify = require('promisify-es6');\n\nconst dagPB = require('ipld-dag-pb');\n\nconst DAGNode = dagPB.DAGNode;\n\nconst LRU = require('lru-cache');\n\nconst lruOptions = {\n  max: 128\n};\nconst cache = LRU(lruOptions);\n\nconst SendOneFile = require('../utils/send-one-file');\n\nconst once = require('once');\n\nmodule.exports = send => {\n  const sendOneFile = SendOneFile(send, 'object/put');\n  return promisify((obj, options, _callback) => {\n    if (typeof options === 'function') {\n      _callback = options;\n      options = {};\n    }\n\n    const callback = once(_callback);\n\n    if (!options) {\n      options = {};\n    }\n\n    let tmpObj = {\n      Data: null,\n      Links: []\n    };\n\n    if (Buffer.isBuffer(obj)) {\n      if (!options.enc) {\n        tmpObj = {\n          Data: obj.toString(),\n          Links: []\n        };\n      }\n    } else if (obj.multihash) {\n      tmpObj = {\n        Data: obj.data.toString(),\n        Links: obj.links.map(l => {\n          const link = l.toJSON();\n          link.hash = link.multihash;\n          return link;\n        })\n      };\n    } else if (typeof obj === 'object') {\n      tmpObj.Data = obj.Data.toString();\n      tmpObj.Links = obj.Links;\n    } else {\n      return callback(new Error('obj not recognized'));\n    }\n\n    let buf;\n\n    if (Buffer.isBuffer(obj) && options.enc) {\n      buf = obj;\n    } else {\n      buf = Buffer.from(JSON.stringify(tmpObj));\n    }\n\n    const enc = options.enc || 'json';\n    const sendOptions = {\n      qs: {\n        inputenc: enc\n      }\n    };\n    sendOneFile(buf, sendOptions, (err, result) => {\n      if (err) {\n        return callback(err); // early\n      }\n\n      if (Buffer.isBuffer(obj)) {\n        if (!options.enc) {\n          obj = {\n            Data: obj,\n            Links: []\n          };\n        } else if (options.enc === 'json') {\n          obj = JSON.parse(obj.toString());\n        }\n      }\n\n      let node;\n\n      if (obj.multihash) {\n        node = obj;\n      } else if (options.enc === 'protobuf') {\n        dagPB.util.deserialize(obj, (err, _node) => {\n          if (err) {\n            return callback(err);\n          }\n\n          node = _node;\n          next();\n        });\n        return;\n      } else {\n        DAGNode.create(Buffer.from(obj.Data), obj.Links, (err, _node) => {\n          if (err) {\n            return callback(err);\n          }\n\n          node = _node;\n          next();\n        });\n        return;\n      }\n\n      next();\n\n      function next() {\n        const nodeJSON = node.toJSON();\n\n        if (nodeJSON.multihash !== result.Hash) {\n          const err = new Error('multihashes do not match');\n          return callback(err);\n        }\n\n        cache.set(result.Hash, node);\n        callback(null, node);\n      }\n    });\n  });\n};","map":null,"metadata":{},"sourceType":"script"}